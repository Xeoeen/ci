#!/usr/bin/env bash

CI_RED="1;31"
CI_GREEN="1;32"
CI_WHITE="37"

CI_CPP_COMPILER="c++"
CI_CPP_STANDARD="-std=c++11"
CI_CPP_WARNINGS="-Wall -Wextra"
CI_CPP_DEBUG="-g -D_GLIBCXX_DEBUG"
CI_CPP_OPTIMISE="-O2 -static -lm"

function ci-ansi-col-escape {
	ARG_VALUES=$1
	echo "\033["$ARG_VALUES"m"
}
function ci-ansi-col-reset {
	echo "\033[0m"
}
function ci-colored {
	ARG_COLOR=$1
	ARG_TEXT=$2
	printf "$(ci-ansi-col-escape $ARG_COLOR)$ARG_TEXT$(ci-ansi-col-reset)"
}
function ci-colordemo {
	declare -a ALLCOLS=("30" "31" "32" "33" "34" "35" "36" "37")
	for COL in "${ALLCOLS[@]}"
	do
		ci-colored "0;$COL" " $COL "
		ci-colored "1;$COL" " 1;$COL \n"
	done
}

function ci-strip-ext {
	ARG_EXT=$1
	ARG_FILE=$2
	echo $(sed -r s/\\.$ARG_EXT//g <<< $ARG_FILE)
}
function ci-build {
	ARG_SOURCE=$1
	$CI_CPP_COMPILER $CI_CPP_STANDARD $CI_CPP_WARNINGS $CI_CPP_DEBUG $ARG_SOURCE -o $(ci-strip-ext cpp $ARG_SOURCE).e
}

function ci-check-test {
	ARG_NAME=$1
	ARG_EXE1=$2
	ARG_EXE2=$3
	ARG_TEST_STR=$4
	OUTPUT1=$($ARG_EXE1 <<< $ARG_TEST_STR)
	OUTPUT2=$($ARG_EXE2 <<< $ARG_TEST_STR)
	diff -bew <(echo $OUTPUT1) <(echo $OUTPUT2) &> /dev/null
	DIFF_RESULT=$?
	if [ $DIFF_RESULT -eq 0 ] ; then
		ci-colored $CI_GREEN 'TEST RUN SUCCESS'
	else
		ci-colored $CI_RED 'TEST RUN FAILURE'
	fi
	echo " "$ARG_NAME
	return $DIFF_RESULT
}

function ci-autotest {
	ARG_EXE1=$1
	ARG_EXE2=$2
	ARG_GEN=$3
	I=1
	while true ; do
		TEST_STRING=$($ARG_GEN)
		ci-check-test "(autogenerated $I)" "$ARG_EXE1" "$ARG_EXE2" "$TEST_STRING"
		if [ $? -ne 0 ] ; then
			echo "$TEST_STRING"
			break
		fi
		let "I += 1"
	done
}

function ci-test-one {
	ARG_EXE=$1
	ARG_TESTNAME=$2
	TEST_INPUT_FILE="$ARG_TESTNAME.in"
	TEST_OUTPUT_FILE="$ARG_TESTNAME.out"
	ci-check-test "$ARG_TESTNAME" "$ARG_EXE" "cat $TEST_OUTPUT_FILE" "$(cat $TEST_INPUT_FILE)"
}
function ci-test {
	ARG_EXE=$1
	ARG_TESTDIR=$2
	for INFILE in $ARG_TESTDIR/**/*.in ; do
		TEST_NAME=$(ci-strip-ext "in" "$INFILE" | sed 's#//*#/#g')
		ci-test-one "$ARG_EXE" "$TEST_NAME"
	done;
}
function ci-multitest {
	ARG_GEN=$1
	ARG_EXE0=$2
	shift
	shift
	I=1
	while true ; do
		TEST_STRING=$($ARG_GEN)

		printf "%-22s" "(autogenerated $I)"

		TIMEFORMAT="%2Rs"

		OUTPUT0_FILE=$(mktemp)
		TIME0=$({ time {
			$ARG_EXE0 <<< $TEST_STRING > $OUTPUT0_FILE
		} } 2>&1 >/dev/null)
		OUTPUT0=$(cat $OUTPUT0_FILE)
		rm $OUTPUT0_FILE

		ci-colored $CI_GREEN " $TIME0"

		for ARG_EXEI in "$@"
		do

			OUTPUTI_FILE=$(mktemp)
			TIME1=$({ time {
				$ARG_EXEI <<< $TEST_STRING > $OUTPUTI_FILE
			} } 2>&1 >/dev/null)
			OUTPUTI=$(cat $OUTPUTI_FILE)
			rm $OUTPUTI_FILE

			diff -bew <(echo $OUTPUT0) <(echo $OUTPUTI) &> /dev/null
			if [ $? -eq 0 ]; then
				ci-colored $CI_GREEN " $TIME1"
			else
				ci-colored $CI_RED " WA\n"
				ci-colored $CI_RED "$ARG_EXEI\n"
				cat <(cat <<< $TEST_STRING)
				exit 0
			fi
		done

		printf "\n"

		let "I += 1"
	done
}

CI_SUBCMD=$1
shift
ci-$CI_SUBCMD "$@"
